<project>
    <shortName>sequoiadb</shortName>
    <fullName>SequoiaDB Server</fullName>
    <version>1.0</version>
    <installerFilename>${product_shortname}-${product_version}-${platform}-installer.${platform_exec_suffix}</installerFilename>
    <allowLanguageSelection>1</allowLanguageSelection>
    <componentList>
        <component>
            <name>SequoiaDB</name>
            <description>SequoiaDB Component</description>
            <canBeEdited>1</canBeEdited>
            <selected>1</selected>
            <show>1</show>
            <customLanguageFileList>
                <language>
                    <code>en</code>
                    <encoding>utf-8</encoding>
                    <file>${build_project_directory}/sequoiadb_en.lng</file>
                </language>
                <language>
                    <code>zh_CN</code>
                    <encoding>utf-8</encoding>
                    <file>${build_project_directory}/sequoiadb_zh.lng</file>
                </language>
            </customLanguageFileList>
            <folderList>
                <folder>
                    <description>Program Files</description>
                    <destination>${installdir}</destination>
                    <name>programfiles</name>
                    <platforms>all</platforms>
                    <distributionFileList>
                        <distributionDirectory>
                            <allowWildcards>1</allowWildcards>
                            <origin>${build_project_directory}/sequoiadb/*</origin>
                        </distributionDirectory>
                    </distributionFileList>
                </folder>
            </folderList>
        </component>
    </componentList>
    <readyToInstallActionList>
        <runProgram>
            <abortOnError>0</abortOnError>
            <customErrorMessage>${msg(Install.ErrorMsg.CreateGroup.error)}</customErrorMessage>
            <program>groupadd</program>
            <programArguments>${username}_group</programArguments>
            <ruleList>
                <platformTest>
                    <type>linux</type>
                </platformTest>
                <userTest>
                    <logic>not_exists</logic>
                    <username>${username}</username>
                </userTest>
            </ruleList>
        </runProgram>
        <runProgram>
            <abortOnError>0</abortOnError>
            <customErrorMessage>${msg(Install.ErrorMsg.CreateGroup.error)}</customErrorMessage>
            <program>useradd</program>
            <programArguments> ${username} -d ${installdir} -g ${username}_group  -s /bin/bash </programArguments>
            <ruleList>
                <platformTest>
                    <type>linux</type>
                </platformTest>
                <userTest>
                    <logic>not_exists</logic>
                    <username>${username}</username>
                </userTest>
            </ruleList>
        </runProgram>
        <runProgram>
            <program>echo</program>
            <programArguments> ${username}:${userpasswd} | chpasswd</programArguments>
            <ruleList>
                <platformTest>
                    <type>linux</type>
                </platformTest>
            </ruleList>
        </runProgram>
        <addGroup>
            <groupname>${username}_group</groupname>
            <showMessageOnError>1</showMessageOnError>
            <ruleList>
                <platformTest>
                    <type>windows</type>
                </platformTest>
            </ruleList>
        </addGroup>
        <addUser>
            <homedir>${installdir}</homedir>
            <password>${userpasswd}</password>
            <showMessageOnError>1</showMessageOnError>
            <username>${username}</username>
            <ruleList>
                <platformTest>
                    <type>windows</type>
                </platformTest>
            </ruleList>
        </addUser>
        <runProgram>
            <program>echo</program>
            <programArguments>3 &gt; /proc/sys/net/ipv4/tcp_retries2</programArguments>
            <ruleList>
                <platformTest>
                    <type>linux</type>
                </platformTest>
            </ruleList>
        </runProgram>
        <exit>
            <exitCode>1</exitCode>
            <ruleList>
                <userTest>
                    <logic>not_exists</logic>
                    <username>${username}</username>
                </userTest>
            </ruleList>
        </exit>
    </readyToInstallActionList>
    <postInstallationActionList>
        <createSymLink>
            <linkName>${installdir}/tools/server/php/libxml2/lib/libxml2.so</linkName>
            <target>${installdir}/tools/server/php/libxml2/lib/libxml2.so.2.9.0</target>
        </createSymLink>
        <createSymLink>
            <linkName>${installdir}/tools/server/php/libxml2/lib/libxml2.so.2</linkName>
            <target>${installdir}/tools/server/php/libxml2/lib/libxml2.so.2.9.0</target>
        </createSymLink>
        <createSymLink>
            <linkName>${installdir}/tools/server/php/libxml2/lib/libz.so</linkName>
            <target>${installdir}/tools/server/php/libxml2/lib/libz.so.1.2.7</target>
        </createSymLink>
        <createSymLink>
            <linkName>${installdir}/tools/server/php/libxml2/lib/libz.so.1</linkName>
            <target>${installdir}/tools/server/php/libxml2/lib/libz.so.1.2.7</target>
        </createSymLink>
        <changeOwnerAndGroup>
            <files>${installdir}/tools/server/php/libxml2/lib</files>
            <group>${username}_group</group>
            <owner>${username}</owner>
        </changeOwnerAndGroup>
        <propertiesFileSet>
            <file>/etc/default/sequoiadb</file>
            <key>NAME</key>
            <value>sdbcm</value>
        </propertiesFileSet>
        <propertiesFileSet>
            <file>/etc/default/sequoiadb</file>
            <key>SDBADMIN_USER</key>
            <value>${username}</value>
        </propertiesFileSet>
        <propertiesFileSet>
            <file>/etc/default/sequoiadb</file>
            <key>INSTALL_DIR</key>
            <value>${installdir}</value>
        </propertiesFileSet>
        <changePermissions files="${installdir}/bin/{*,*/*}" permissions="0755">
            <customErrorMessage>${msg(Install.ErrorMsg.ChangeInsallerPathPermissions.error)}</customErrorMessage>
        </changePermissions>
        <changePermissions>
            <files>${installdir}/tools/server/php/bin/*</files>
            <permissions>0755</permissions>
        </changePermissions>
        <changePermissions>
            <files>${installdir}/www/shell/*</files>
            <permissions>0755</permissions>
        </changePermissions>
        <changePermissions>
            <files>${installdir}/install_om.sh</files>
            <permissions>0755</permissions>
        </changePermissions>
        <dos2unix>
            <files>${installdir}/tools/server/php/bin/php</files>
        </dos2unix>
        <iniFileSet>
            <file>${installdir}/tools/server/php/lib/php.ini</file>
            <key>extension_dir</key>
            <section>PHP</section>
            <value>${installdir}/lib/phplib</value>
        </iniFileSet>
        <changePermissions>
            <files>${installdir}/java/jdk/bin/*</files>
            <permissions>0755</permissions>
        </changePermissions>
        <propertiesFileSet>
            <file>${installdir}/conf/sdbcm.conf</file>
            <key>defaultPort</key>
            <value>${port}</value>
        </propertiesFileSet>
        <createWindowsService>
            <abortOnError>1</abortOnError>
            <customErrorMessage>${msg(Install.ErrorMsg.CreateService.error)}</customErrorMessage>
            <description>SequoiaDB Cluster Manager</description>
            <displayName>SequoiaDB Cluster Manager</displayName>
            <program>${installdir}\bin\sdbcm.exe</program>
            <programArguments></programArguments>
            <serviceName>sdbcm</serviceName>
            <startType>auto</startType>
        </createWindowsService>
        <startWindowsService>
            <customErrorMessage>${msg(Install.ErrorMsg.StartWindowsService.error)}</customErrorMessage>
            <delay>15000</delay>
            <displayName>SequoiaDB Cluster Manager</displayName>
            <serviceName>sdbcm</serviceName>
            <ruleList>
                <windowsServiceTest>
                    <condition>exists</condition>
                    <service>sdbcm</service>
                </windowsServiceTest>
            </ruleList>
        </startWindowsService>
        <addUnixService>
            <customErrorMessage>${msg(Install.ErrorMsg.CreateLinuxService.error)}</customErrorMessage>
            <description>SequoiaDB Cluster Manager</description>
            <name>sdbcm</name>
            <program>${installdir}/sequoiadb</program>
            <ruleEvaluationLogic>or</ruleEvaluationLogic>
            <ruleList>
                <platformTest>
                    <type>linux</type>
                </platformTest>
            </ruleList>
        </addUnixService>
        <propertiesFileSet>
            <file>${installdir}/conf/sdbcm.conf</file>
            <key>AutoStart</key>
            <value>false</value>
            <ruleList>
                <isTrue>
                    <negate>1</negate>
                    <value>${processAutoStart}</value>
                </isTrue>
                <platformTest>
                    <type>linux</type>
                </platformTest>
            </ruleList>
        </propertiesFileSet>
        <runProgram>
            <program>/etc/init.d/sdbcm</program>
            <programArguments>start</programArguments>
            <ruleList>
                <platformTest>
                    <type>linux</type>
                </platformTest>
            </ruleList>
        </runProgram>
        <runProgram>
            <customErrorMessage>${msg(Install.ErrorMsg.IntallationOM.error)}</customErrorMessage>
            <program>${installdir}/install_om.sh</program>
            <programArguments>${installdir} ${port} ${svcname} ${dbpath} ${restname} ${installer_pathname}</programArguments>
            <ruleEvaluationLogic>or</ruleEvaluationLogic>
            <ruleList>
                <isTrue>
                    <value>${OM}</value>
                </isTrue>
                <isTrue>
                    <value>${SMS}</value>
                </isTrue>
            </ruleList>
        </runProgram>
        <changePermissions>
            <files>${installdir}/postgresql/*</files>
            <permissions>0755</permissions>
        </changePermissions>
        <changePermissions>
            <files>/tmp</files>
            <permissions>0777</permissions>
        </changePermissions>
        <changeOwnerAndGroup>
            <files>${installdir}/packet/*</files>
            <group>${username}_group</group>
            <owner>${username}</owner>
        </changeOwnerAndGroup>
        <changeOwnerAndGroup>
            <files>${installdir}/bin/sdbomtool</files>
            <group>root</group>
            <owner>root</owner>
        </changeOwnerAndGroup>
        <runProgram>
            <program>chmod</program>
            <programArguments>4755 ${installdir}/bin/sdbomtool</programArguments>
            <ruleList>
                <platformTest>
                    <type>linux</type>
                </platformTest>
            </ruleList>
        </runProgram>
    </postInstallationActionList>
    <preUninstallationActionList>
        <stopWindowsService>
            <abortOnError>1</abortOnError>
            <customErrorMessage>${msg(Install.ErrorMsg.StopSdbCm.error)}</customErrorMessage>
            <delay>15000</delay>
            <displayName>SequoiaDB Cluster Manager</displayName>
            <serviceName>sdbcm</serviceName>
            <ruleList>
                <windowsServiceTest>
                    <condition>is_running</condition>
                    <service>sdbcm</service>
                </windowsServiceTest>
            </ruleList>
        </stopWindowsService>
        <deleteWindowsService>
            <abortOnError>1</abortOnError>
            <displayName>SequoiaDB Cluster Manager</displayName>
            <serviceName>sdbcm</serviceName>
        </deleteWindowsService>
        <runProgram>
            <program>service</program>
            <programArguments>sdbcm stop</programArguments>
            <ruleList>
                <platformTest>
                    <type>linux</type>
                </platformTest>
            </ruleList>
        </runProgram>
        <removeUnixService>
            <name>sdbcm</name>
            <ruleEvaluationLogic>or</ruleEvaluationLogic>
            <ruleList>
                <platformTest>
                    <type>linux</type>
                </platformTest>
            </ruleList>
        </removeUnixService>
        <runProgram>
            <program>${installdir}/bin/sdbstop</program>
            <programArguments></programArguments>
            <ruleList>
                <platformTest>
                    <type>linux</type>
                </platformTest>
            </ruleList>
        </runProgram>
    </preUninstallationActionList>
    <postUninstallationActionList>
        <deleteFile>
            <path>/etc/default/sequoiadb</path>
            <ruleList>
                <platformTest>
                    <type>linux</type>
                </platformTest>
                <fileExists>
                    <path>/etc/default/sequoiadb</path>
                </fileExists>
            </ruleList>
        </deleteFile>
    </postUninstallationActionList>
    <allowedLanguages>en zh_CN</allowedLanguages>
    <debuggerPassword>sequoiadb</debuggerPassword>
    <defaultUnixGroup>${username}_group</defaultUnixGroup>
    <defaultUnixOwner>${username}</defaultUnixOwner>
    <enableDebugger>1</enableDebugger>
    <enableRollback>1</enableRollback>
    <enableTimestamp>1</enableTimestamp>
    <requireInstallationByRootUser>1</requireInstallationByRootUser>
    <saveRelativePaths>1</saveRelativePaths>
    <singleInstanceCheck>1</singleInstanceCheck>
    <vendor>SequoiaDB</vendor>
    <installationAbortedActionList>
        <deleteWindowsService>
            <displayName>SequoiaDB Cluster Manager</displayName>
            <serviceName>sdbcm</serviceName>
            <ruleList>
                <windowsServiceTest>
                    <condition>exists</condition>
                    <service>sdbcm</service>
                </windowsServiceTest>
            </ruleList>
        </deleteWindowsService>
        <removeUnixService>
            <name>sdbcm</name>
            <ruleEvaluationLogic>or</ruleEvaluationLogic>
            <ruleList>
                <platformTest>
                    <type>linux</type>
                </platformTest>
            </ruleList>
        </removeUnixService>
        <deleteFile>
            <abortOnError>0</abortOnError>
            <path>/etc/default/sequoiadb</path>
            <ruleList>
                <platformTest>
                    <type>linux</type>
                </platformTest>
                <fileExists>
                    <path>/etc/default/sequoiadb</path>
                </fileExists>
            </ruleList>
        </deleteFile>
        <runProgram>
            <customErrorMessage>${msg(Install.ErrorMsg.DeleteUser.error)}</customErrorMessage>
            <program>userdel</program>
            <programArguments>${username}</programArguments>
            <ruleList>
                <userTest>
                    <logic>exists</logic>
                    <password>${username}</password>
                    <username>${username}</username>
                </userTest>
                <platformTest>
                    <type>linux</type>
                </platformTest>
            </ruleList>
        </runProgram>
        <deleteGroup>
            <groupname>${username}_group</groupname>
        </deleteGroup>
    </installationAbortedActionList>
    <licenseFileList>
        <licenseFile>
            <code>en</code>
            <file>${build_project_directory}/sequoiadb/license/license_en.txt</file>
        </licenseFile>
        <licenseFile>
            <code>zh_CN</code>
            <encoding>utf-8</encoding>
            <file>${build_project_directory}/sequoiadb/license/license_zh.txt</file>
        </licenseFile>
    </licenseFileList>
    <parameterList>
        <choiceParameterGroup>
            <name>licenseRead</name>
            <description>Install.Paramers.LicenseRead.License.Information.Part</description>
            <explanation></explanation>
            <value>1</value>
            <default>1</default>
            <cliOptionShow>0</cliOptionShow>
            <parameterList>
                <licenseParameter>
                    <name>license_empty</name>
                    <title>License Agreement</title>
                    <description>Install.Paramers.LicenseRead.Agree.Description</description>
                    <explanation>Install.Paramers.LicenseRead.Agree.Explanation</explanation>
                    <file>${build_project_directory}/license_empty.txt</file>
                    <htmlFile></htmlFile>
                </licenseParameter>
                <licenseParameter>
                    <name>read</name>
                    <title>License Agreement</title>
                    <description>Install.Paramers.LicenseRead.Read.Description</description>
                    <explanation></explanation>
                    <file>${build_project_directory}/sequoiadb/license/license_en.txt</file>
                    <htmlFile></htmlFile>
                    <wrapText>1</wrapText>
                    <licenseFileList>
                        <licenseFile>
                            <code>zh_CN</code>
                            <encoding>utf-8</encoding>
                            <file>${build_project_directory}/sequoiadb/license/license_zh.txt</file>
                        </licenseFile>
                    </licenseFileList>
                </licenseParameter>
            </parameterList>
        </choiceParameterGroup>
        <parameterGroup>
            <name>ActionGroup</name>
            <explanation></explanation>
            <value></value>
            <default></default>
            <parameterList>
                <directoryParameter>
                    <name>installdir</name>
                    <description>Installer.Parameter.installdir.description</description>
                    <explanation>Installer.Parameter.installdir.explanation</explanation>
                    <value></value>
                    <default>${platform_install_prefix}/${product_shortname}</default>
                    <allowEmptyValue>0</allowEmptyValue>
                    <ask>yes</ask>
                    <cliOptionName>prefix</cliOptionName>
                    <mustBeWritable>yes</mustBeWritable>
                    <mustExist>0</mustExist>
                    <width>40</width>
                </directoryParameter>
                <stringParameter>
                    <name>platform</name>
                    <description></description>
                    <explanation></explanation>
                    <value>${platform_name}</value>
                    <default>${platform_name}</default>
                    <allowEmptyValue>0</allowEmptyValue>
                    <ask>0</ask>
                    <cliOptionShow>0</cliOptionShow>
                    <width>40</width>
                </stringParameter>
                <parameterGroup>
                    <name>user_data</name>
                    <title>${msg(Install.Paramers.user.title)}</title>
                    <explanation>${msg(Install.Paramers.user.explanation)}</explanation>
                    <value></value>
                    <default></default>
                    <parameterList>
                        <stringParameter>
                            <name>username</name>
                            <description>${msg(Install.Paramers.user.username.description)}</description>
                            <explanation></explanation>
                            <value>sdbadmin</value>
                            <default>sdbadmin</default>
                            <allowEmptyValue>0</allowEmptyValue>
                            <width>40</width>
                        </stringParameter>
                        <passwordParameter>
                            <name>userpasswd</name>
                            <description>${msg(Install.Paramers.user.password.description)}</description>
                            <explanation></explanation>
                            <value></value>
                            <default>${username}</default>
                            <allowEmptyValue>0</allowEmptyValue>
                            <descriptionRetype>${msg(Install.Paramers.user.reentry_password.description)}</descriptionRetype>
                            <width>20</width>

                            <!-- throw an error if password is empty -->
                            <validationActionList>
                                <throwError>
                                    <text>${msg(Install.Paramers.user.password.error)}</text>
                                    <ruleList>
                                        <compareText logic="equals" text="${userpasswd}" value=""/>
                                    </ruleList>
                                </throwError>
                            </validationActionList>
                        </passwordParameter>
                    </parameterList>
                </parameterGroup>
                <stringParameter>
                    <name>port</name>
                    <title>${msg(Install.Paramers.port.title)}</title>
                    <description>${msg(Install.Paramers.port.Description)}</description>
                    <explanation>${msg(Install.Paramers.port.explanation)}</explanation>
                    <value>11790</value>
                    <default>11790</default>
                    <allowEmptyValue>1</allowEmptyValue>
                    <width>40</width>
                </stringParameter>
                <booleanParameter>
                    <name>processAutoStart</name>
                    <description>${msg(Install.Paramers.processAutoStart.Description)}</description>
                    <explanation>${msg(Install.Paramers.processAutoStart.explanation)}</explanation>
                    <value>true</value>
                    <default>true</default>
                    <cliOptionText>${msg(Install.Paramers.processAutoStart.explanation)}</cliOptionText>
                </booleanParameter>
                <stringParameter>
                    <name>svcname</name>
                    <description></description>
                    <explanation></explanation>
                    <value>11780</value>
                    <default>11780</default>
                    <allowEmptyValue>1</allowEmptyValue>
                    <ask>0</ask>
                    <cliOptionName>svcname</cliOptionName>
                    <cliOptionText>${msg(Installer.Paramers.svcnamePort.explanation)}</cliOptionText>
                    <ruleEvaluationLogic>or</ruleEvaluationLogic>
                    <width>40</width>
                    <ruleList>
                        <isTrue>
                            <value>${SMS}</value>
                        </isTrue>
                    </ruleList>
                </stringParameter>
                <directoryParameter>
                    <name>dbpath</name>
                    <description></description>
                    <explanation></explanation>
                    <value></value>
                    <default>${installdir}/database/sms/${svcname}</default>
                    <allowEmptyValue>1</allowEmptyValue>
                    <ask>0</ask>
                    <cliOptionName>dbpath</cliOptionName>
                    <cliOptionText>${msg(Installer.Paramers.dbpath.explanation)}</cliOptionText>
                    <mustBeWritable>0</mustBeWritable>
                    <mustExist>0</mustExist>
                    <ruleEvaluationLogic>or</ruleEvaluationLogic>
                    <width>40</width>
                    <ruleList>
                        <isTrue>
                            <value>${SMS}</value>
                        </isTrue>
                    </ruleList>
                </directoryParameter>
                <stringParameter>
                    <name>restname</name>
                    <description></description>
                    <explanation></explanation>
                    <value>8000</value>
                    <default>8000</default>
                    <allowEmptyValue>1</allowEmptyValue>
                    <ask>0</ask>
                    <cliOptionName>restname</cliOptionName>
                    <cliOptionText>${msg(Installer.Paramers.restPort.explanation)}</cliOptionText>
                    <ruleEvaluationLogic>or</ruleEvaluationLogic>
                    <width>40</width>
                    <ruleList>
                        <isTrue>
                            <value>${SMS}</value>
                        </isTrue>
                    </ruleList>
                </stringParameter>
                <booleanParameter>
                    <name>SMS</name>
                    <description>${msg(Installer.Paramers.sms.description)}</description>
                    <explanation></explanation>
                    <value></value>
                    <default>false</default>
                    <cliOptionName>SMS</cliOptionName>
                    <cliOptionText>${msg(Installer.Paramers.installationType.explanation)}</cliOptionText>
                    <ruleEvaluationLogic>or</ruleEvaluationLogic>
                    <ruleList>
                        <isFalse>
                            <value>${SMS}</value>
                        </isFalse>
                    </ruleList>
                </booleanParameter>
            </parameterList>
        </parameterGroup>
    </parameterList>
</project>

